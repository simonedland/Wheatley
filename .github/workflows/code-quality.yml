name: Python Code Quality Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  issues: write

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Install linters (pin Flake8 6.x for SARIF compatibility)
      - name: Install Flake8 + plugins
        run: |
          python -m pip install -U pip
          pip install "flake8<7" \
                      flake8-bugbear \
                      flake8-docstrings \
                      pep8-naming \
                      flake8-cognitive-complexity \
                      flake8-sarif

      # Optional project deps; keep going if it fails
      - name: Install project requirements (best-effort)
        run: |
          if [ -f requirements.txt ]; then
            echo "Installing requirements.txt â€¦"
            if ! pip install -r requirements.txt; then
              echo "::warning::requirements.txt failed to install; continuing lint."
            fi
          else
            echo "No requirements.txt â€“ skipping."
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1) Flake8 â†’ console annotations
      - name: Run Flake8 â†’ console
        id: flake8
        env:
          REPORT: flake8-report.txt
        run: |
          flake8 . \
            --ignore=E501 \
            --max-complexity=10 \
            --max-cognitive-complexity=10 \
            --format='::error file=%(path)s,line=%(row)d,col=%(col)d::%(code)s %(text)s' \
            > "$REPORT" || true
          cat "$REPORT"
          echo "issue_count=$(grep -c '^::error' "$REPORT" || true)" >> "$GITHUB_OUTPUT"
          # ensure report file exists even if flake8 crashed
          [ -s "$REPORT" ] || touch "$REPORT"

      # 2) Flake8 â†’ SARIF
      - name: Run Flake8 â†’ SARIF
        id: sarif
        env:
          SARIF_FILE: flake8-results.sarif
        run: |
          flake8 . \
            --ignore=E501 \
            --max-complexity=10 \
            --max-cognitive-complexity=10 \
            --format sarif \
            --output-file "$SARIF_FILE" || true
          # stub if missing
          [ -f "$SARIF_FILE" ] || \
            echo '{"version":"2.1.0","runs":[{"tool":{"driver":{"name":"flake8"}},"results":[]} ]}' > "$SARIF_FILE"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload SARIF + raw log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flake8-results
          path: |
            flake8-results.sarif
            flake8-report.txt
          if-no-files-found: warn   # never fail the job for missing files

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # GitHub Issue sync (unchanged logic)
      - name: Create or Update GitHub Issues per File
        if: github.event_name == 'push'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          awk -F 'file=' '/^::error/ {split($2,a,","); print a[1]}' flake8-report.txt | sort -u > files_with_issues.txt
          while IFS= read -r file; do
            grep "file=$file," flake8-report.txt | head -n 100 > file-issues.txt
            [ -s file-issues.txt ] || continue
            ISSUE_TITLE="Code quality issues in $file"
            CURRENT_COUNT=$(wc -l < file-issues.txt)
            { echo "### ðŸš¨ flake8 issues in $file (first 100 lines)"
              echo '```'; cat file-issues.txt; echo '```'
              echo "Log: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              echo "Commit: ${{ github.sha }}"
              echo "Error count: $CURRENT_COUNT"; } > issue_body.md
            ISSUE_NUMBER=$(gh issue list --state open --search "$ISSUE_TITLE" --json number,title |
              jq -r '.[]|select(.title=="'"$ISSUE_TITLE"'")|.number' | head -n1)
            if [ -n "$ISSUE_NUMBER" ]; then
              LAST_COUNT=$(gh issue view "$ISSUE_NUMBER" --json comments |
                jq -r '.comments|last|.body' |
                grep -oE 'Error count: [0-9]+' | awk '{print $3}' || true)
              [ "$CURRENT_COUNT" != "$LAST_COUNT" ] && \
                gh issue comment "$ISSUE_NUMBER" --body-file issue_body.md || true
            else
              gh issue create --title "$ISSUE_TITLE" --body-file issue_body.md || true
            fi
          done < files_with_issues.txt

      - name: Close resolved code quality issues
        if: steps.flake8.outputs.issue_count >= 0 && github.event_name == 'push'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue list --state open --json number,title |
          jq -r '.[]|select(.title|startswith("Code quality issues in "))|[.number,.title]|@tsv' > open.tsv
          mapfile -t current_files < files_with_issues.txt
          while IFS=$'\t' read -r num title; do
            file=${title#Code quality issues in }
            if ! printf '%s\n' "${current_files[@]}" | grep -Fxq "$file"; then
              gh issue comment "$num" --body "âœ… All flake8 issues in \`$file\` resolved. Closing."
              gh issue close "$num"
            fi
          done < open.tsv
